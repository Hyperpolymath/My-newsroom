# GitLab CI/CD Pipeline for My-newsroom (Julia + Rust)
# RSR-compliant automated testing

variables:
  JULIA_VERSION: "1.9"
  CARGO_HOME: "$CI_PROJECT_DIR/.cache/cargo"

cache:
  paths:
    - .cache/cargo
    - target/

stages:
  - test
  - build
  - security
  - deploy

# Julia testing
julia:test:
  stage: test
  image: julia:${JULIA_VERSION}
  before_script:
    - julia --project=. -e 'using Pkg; Pkg.instantiate()'
  script:
    - julia --project=. test/runtests.jl
  allow_failure: false

# Rust testing
rust:test:
  stage: test
  image: rust:latest
  script:
    - cd solo-compiler && cargo test --all --verbose
  only:
    changes:
      - "solo-compiler/**/*.rs"
      - "solo-compiler/Cargo.toml"

# Rust linting
rust:lint:
  stage: test
  image: rust:latest
  script:
    - cd solo-compiler && cargo fmt -- --check
    - cd solo-compiler && cargo clippy -- -D warnings
  only:
    changes:
      - "solo-compiler/**/*.rs"
      - "solo-compiler/Cargo.toml"

# Security - Rust
security:rust:
  stage: security
  image: rust:latest
  before_script:
    - cargo install cargo-audit
  script:
    - cd solo-compiler && cargo audit
  allow_failure: true
  only:
    changes:
      - "solo-compiler/Cargo.toml"

# Build Rust
build:rust:
  stage: build
  image: rust:latest
  script:
    - cd solo-compiler && cargo build --release
  artifacts:
    paths:
      - solo-compiler/target/release/solo
    expire_in: 1 week
  only:
    changes:
      - "solo-compiler/**/*.rs"
      - "solo-compiler/Cargo.toml"

# RSR compliance
validate:rsr:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache bash
  script:
    - sh -c 'test -f README.md || (echo "❌ README.md missing" && exit 1)'
    - sh -c 'test -f LICENSE.txt || (echo "❌ LICENSE.txt missing" && exit 1)'
    - sh -c 'test -f SECURITY.md || (echo "❌ SECURITY.md missing" && exit 1)'
    - sh -c 'test -f .well-known/security.txt || (echo "❌ security.txt missing" && exit 1)'
    - echo "✅ RSR Bronze level requirements met"
  allow_failure: false

# Documentation
pages:
  stage: deploy
  image: julia:${JULIA_VERSION}
  script:
    - julia --project=docs -e 'using Pkg; Pkg.develop(PackageSpec(path=pwd())); Pkg.instantiate()'
    - julia --project=docs docs/make.jl
    - mv docs/build public
  artifacts:
    paths:
      - public
  only:
    - main
